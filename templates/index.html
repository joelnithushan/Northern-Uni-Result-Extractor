<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Center Results Extractor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #ffae00 0%, #ff9100 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #242d66 0%, #1a2152 100%);
            color: white;
            padding: 40px;
            text-align: center;
            position: relative;
        }

        .header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #ffae00 0%, #ff9100 100%);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .input-section {
            padding: 40px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 10px;
            color: #242d66;
            font-weight: 600;
            font-size: 1.1em;
        }

        textarea {
            width: 100%;
            min-height: 200px;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            resize: vertical;
        }

        textarea:focus {
            outline: none;
            border-color: #ffae00;
        }

        .btn {
            background: linear-gradient(135deg, #ffae00 0%, #ff9100 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.1em;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
            width: 100%;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(255, 174, 0, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 174, 0, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .results-section {
            padding: 40px;
            display: none;
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .statistics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #242d66 0%, #1a2152 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            border-top: 4px solid #ffae00;
            box-shadow: 0 4px 15px rgba(36, 45, 102, 0.2);
            transition: transform 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 20px rgba(36, 45, 102, 0.3);
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 1em;
            opacity: 0.9;
        }

        .table-wrapper {
            max-height: 600px;
            overflow-y: auto;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-top: 20px;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            margin: 0;
        }

        .results-table thead {
            background: linear-gradient(135deg, #242d66 0%, #1a2152 100%);
            color: white;
        }

        .results-table th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            background: linear-gradient(135deg, #242d66 0%, #1a2152 100%);
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-bottom: 3px solid #ffae00;
        }

        .results-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }

        .results-table tbody tr:hover {
            background: #f8f9fa;
            transform: scale(1.01);
            transition: all 0.2s ease;
        }

        .results-table tbody tr:nth-child(even) {
            background: #fafafa;
        }

        .results-table tbody tr:nth-child(even):hover {
            background: #f0f0f0;
        }

        .results-table tbody tr:last-child td {
            border-bottom: none;
        }

        .grade-pass {
            color: #28a745;
            font-weight: bold;
        }

        .grade-fail {
            color: #dc3545;
            font-weight: bold;
        }

        .error {
            background: #fee;
            color: #c33;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            display: none;
        }

        .success {
            background: #efe;
            color: #3c3;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            display: none;
        }

        .export-btn {
            background: linear-gradient(135deg, #242d66 0%, #1a2152 100%);
            margin-top: 20px;
            box-shadow: 0 4px 15px rgba(36, 45, 102, 0.3);
        }

        .export-btn:hover {
            background: linear-gradient(135deg, #2d3a7a 0%, #242d66 100%);
            box-shadow: 0 6px 20px rgba(36, 45, 102, 0.4);
        }

        .help-text {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            color: #666;
            font-size: 0.9em;
            border-left: 4px solid #ffae00;
        }

        .help-text strong {
            color: #242d66;
        }

        .file-upload-area {
            margin-bottom: 10px;
        }

        .file-upload-box {
            border: 3px dashed #242d66;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        .file-upload-box:hover {
            border-color: #ffae00;
            background: #fff7e6;
            border-style: solid;
        }

        .file-upload-box.drag-over {
            border-color: #28a745;
            background: #e8f5e9;
        }

        .file-upload-box p {
            margin: 5px 0;
            color: #242d66;
            font-weight: 600;
        }

        .file-upload-box:hover p {
            color: #ffae00;
        }

        .file-name {
            font-size: 0.9em;
            color: #666 !important;
            font-weight: normal !important;
            margin-top: 10px !important;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes fadeInRow {
            from { 
                opacity: 0; 
                transform: translateX(-10px); 
            }
            to { 
                opacity: 1; 
                transform: translateX(0); 
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Center Results Extractor</h1>
            <p>Upload any module result PDF to automatically extract your center's 51 student grades</p>
            <p style="margin-top: 10px; font-size: 0.9em;">Total Students: <strong>{{ total_students }}</strong></p>
        </div>

        <div class="input-section">
            <div class="help-text">
                <strong>How to use:</strong> Upload any module result PDF file. The system will automatically extract and display only your center's 51 student results.
            </div>
            
            <!-- PDF Upload Section -->
            <div class="input-group">
                <label for="pdfFile">Upload Result PDF:</label>
                <div class="file-upload-area" id="fileUploadArea">
                    <input type="file" id="pdfFile" accept=".pdf" style="display: none;" onchange="handleFileSelect(this)">
                    <div class="file-upload-box" id="fileUploadBox" onclick="document.getElementById('pdfFile').click()" 
                     ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                        <p>Click to select PDF or drag and drop</p>
                        <p class="file-name" id="fileName">No file selected</p>
                    </div>
                </div>
                <button class="btn" onclick="uploadPDF()" id="uploadBtn" style="margin-top: 15px;">Upload & Extract Results</button>
            </div>
            
            <div class="error" id="errorMsg"></div>
            <div class="success" id="successMsg"></div>
        </div>

        <div class="loading" id="loading" style="display: none; text-align: center; padding: 40px;">
            <div style="border: 4px solid #f3f3f3; border-top: 4px solid #ffae00; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
            <p>Processing results... Please wait</p>
        </div>

        <div class="results-section" id="resultsSection">
            <h2 style="margin-bottom: 20px; color: #242d66; text-align: center; font-size: 2em;">
                Your Center's Results
            </h2>
            <p style="text-align: center; color: #666; margin-bottom: 30px;">
                Showing results for <strong>{{ total_students }}</strong> students
            </p>
            
            <div class="statistics" id="statistics">
                <!-- Statistics will be inserted here -->
            </div>

            <div class="table-wrapper">
                <table class="results-table">
                    <thead>
                        <tr>
                            <th>IT Number</th>
                            <th>Name</th>
                            <th>CA Marks</th>
                            <th>Grade</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="resultsTableBody">
                        <!-- Results will be inserted here -->
                    </tbody>
                </table>
            </div>

            <button class="btn export-btn" onclick="exportToCSV()">Export to CSV</button>
        </div>
    </div>

    <script>
        // Your center's students
        const centerStudents = {
            "IT23542556": "Sobiyan S",
            "IT23556652": "Joel Nithushan A.T",
            "IT23570962": "Lowmika.L",
            "IT23571020": "Jeyanash.J",
            "IT23581616": "Nirojan.G",
            "IT23581852": "Athithya M",
            "IT23607996": "Sureka A",
            "IT23611610": "Kenuja S",
            "IT23615816": "Vytheki.S",
            "IT23635784": "Kajana.P",
            "IT23635852": "Gowsikan.S",
            "IT23670716": "Vaishnavi S",
            "IT23670952": "Vaishnavi.R",
            "IT23671324": "Heasma.R",
            "IT23683204": "Diltan A",
            "IT23683372": "Kajaluxsan.K",
            "IT23683440": "Anoji.A",
            "IT23683518": "Sarmilan S",
            "IT23717268": "Sivamsan S",
            "IT23717336": "Vaishnavi.L",
            "IT23717572": "Kageepan K",
            "IT23717718": "Adshaya S",
            "IT23717886": "Kiripavan.N",
            "IT23733176": "Biranavy R",
            "IT23739048": "Croos R R A F",
            "IT23739802": "Arun.N",
            "IT23748644": "Kanistan T",
            "IT23752504": "Kajapirathap.J",
            "IT23752672": "Seyon.K",
            "IT23759152": "Saranjan.P",
            "IT23760592": "Gaayaththri M",
            "IT23760660": "Shiromy K B",
            "IT23764934": "Keerthanan N",
            "IT23767454": "Kavithushan B",
            "IT23777354": "Kobitharsan T",
            "IT23778344": "Rishikeshan S",
            "IT23794566": "Gowsika S",
            "IT23794634": "Sinthujan S",
            "IT23794702": "Croos K M C",
            "IT23794870": "Thushalini U",
            "IT23810778": "Subasthican M",
            "IT23811454": "Ahsan M S M",
            "IT23811690": "Pakeerathan B",
            "IT23848566": "Lavan K",
            "IT23849174": "Christhuraja R",
            "IT23855328": "Nivethika K",
            "IT23856240": "Sinthujan P",
            "IT23863484": "Jathushan V",
            "IT23863552": "Shambavi S",
            "IT23204416": "Braveenraj",
            "IT22545862": "Vinushan"
        };

        let currentResults = [];

        function formatITNumber(itStr) {
            // Remove spaces and convert to standard format
            const cleaned = itStr.replace(/\s+/g, '');
            if (cleaned.startsWith('IT') && cleaned.length === 10) {
                return cleaned;
            }
            // Try to parse IT XX XXXX XX format
            const match = itStr.match(/IT\s*(\d{2})\s*(\d{4})\s*(\d{2})/);
            if (match) {
                return `IT${match[1]}${match[2]}${match[3]}`;
            }
            return null;
        }

        function parseResultLine(line) {
            line = line.trim();
            if (!line) return null;

            // Pattern 1: IT XX XXXX XX [marks] [grade] [status]
            let match = line.match(/IT\s*(\d{2})\s*(\d{4})\s*(\d{2})\s+(\d+\.?\d*)\s+([A-F][+-]?)\s+(Pass|Fail)/i);
            if (match) {
                return {
                    it_number: `IT${match[1]}${match[2]}${match[3]}`,
                    ca_marks: parseFloat(match[4]),
                    grade: match[5],
                    status: match[6]
                };
            }

            // Pattern 2: ITXXXXXXXX [marks] [grade] [status]
            match = line.match(/IT(\d{8})\s+(\d+\.?\d*)\s+([A-F][+-]?)\s+(Pass|Fail)/i);
            if (match) {
                return {
                    it_number: `IT${match[1]}`,
                    ca_marks: parseFloat(match[2]),
                    grade: match[3],
                    status: match[4]
                };
            }

            // Pattern 3: IT XX XXXX XX [marks] only (number and marks)
            match = line.match(/IT\s*(\d{2})\s*(\d{4})\s*(\d{2})\s+(\d+\.?\d*)/i);
            if (match) {
                return {
                    it_number: `IT${match[1]}${match[2]}${match[3]}`,
                    ca_marks: parseFloat(match[4]),
                    grade: null,
                    status: null
                };
            }

            // Pattern 4: ITXXXXXXXX [marks] only (number and marks)
            match = line.match(/IT(\d{8})\s+(\d+\.?\d*)/i);
            if (match) {
                return {
                    it_number: `IT${match[1]}`,
                    ca_marks: parseFloat(match[2]),
                    grade: null,
                    status: null
                };
            }

            return null;
        }

        function handleFileSelect(input) {
            const fileName = input.files[0] ? input.files[0].name : 'No file selected';
            document.getElementById('fileName').textContent = fileName;
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.stopPropagation();
            document.getElementById('fileUploadBox').classList.add('drag-over');
        }

        function handleDragLeave(event) {
            event.preventDefault();
            event.stopPropagation();
            document.getElementById('fileUploadBox').classList.remove('drag-over');
        }

        function handleDrop(event) {
            event.preventDefault();
            event.stopPropagation();
            document.getElementById('fileUploadBox').classList.remove('drag-over');
            
            const files = event.dataTransfer.files;
            if (files.length > 0 && files[0].type === 'application/pdf') {
                document.getElementById('pdfFile').files = files;
                document.getElementById('fileName').textContent = files[0].name;
            } else {
                alert('Please drop a PDF file.');
            }
        }

        function uploadPDF() {
            const fileInput = document.getElementById('pdfFile');
            const file = fileInput.files[0];
            const errorMsg = document.getElementById('errorMsg');
            const successMsg = document.getElementById('successMsg');
            const resultsSection = document.getElementById('resultsSection');
            const loading = document.getElementById('loading');
            const uploadBtn = document.getElementById('uploadBtn');

            if (!file) {
                errorMsg.textContent = 'Please select a PDF file first.';
                errorMsg.style.display = 'block';
                successMsg.style.display = 'none';
                return;
            }

            // Show loading
            loading.style.display = 'block';
            resultsSection.style.display = 'none';
            errorMsg.style.display = 'none';
            successMsg.style.display = 'none';
            uploadBtn.disabled = true;
            uploadBtn.textContent = 'Processing...';

            const formData = new FormData();
            formData.append('pdf_file', file);

            fetch('/upload_pdf', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                loading.style.display = 'none';
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'Upload & Extract Results';

                if (data.error) {
                    errorMsg.textContent = data.error;
                    errorMsg.style.display = 'block';
                    successMsg.style.display = 'none';
                    return;
                }

                currentResults = data.results;
                displayResults(data.results, data.statistics);
                
                successMsg.textContent = `Successfully extracted ${data.statistics.total_found} student results from PDF!`;
                successMsg.style.display = 'block';
                errorMsg.style.display = 'none';
            })
            .catch(error => {
                loading.style.display = 'none';
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'Upload & Extract Results';
                errorMsg.textContent = 'Error uploading PDF: ' + error.message;
                errorMsg.style.display = 'block';
                successMsg.style.display = 'none';
            });
        }


        function displayResults(results, statistics) {
            // Use provided statistics or calculate from results
            if (!statistics) {
                const passed = results.filter(r => r.status === 'Pass').length;
                const failed = results.length - passed;
                const passRate = results.length > 0 ? ((passed / results.length) * 100).toFixed(1) : 0;
                statistics = {
                    total_found: results.length,
                    passed: passed,
                    failed: failed,
                    pass_rate: passRate + '%'
                };
            }

            // Display statistics
            const statsHTML = `
                <div class="stat-card">
                    <div class="stat-value">${statistics.total_found}</div>
                    <div class="stat-label">Found</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${statistics.passed}</div>
                    <div class="stat-label">Passed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${statistics.failed}</div>
                    <div class="stat-label">Failed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${statistics.pass_rate || ((statistics.passed / statistics.total_found) * 100).toFixed(1) + '%'}</div>
                    <div class="stat-label">Pass Rate</div>
                </div>
            `;
            document.getElementById('statistics').innerHTML = statsHTML;

            // Display results table
            const tbody = document.getElementById('resultsTableBody');
            if (results.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px; color: #999;">No results found for your center students.</td></tr>';
            } else {
                tbody.innerHTML = results.map((result, index) => `
                    <tr style="animation: fadeInRow 0.3s ease-in ${index * 0.05}s both;">
                        <td><strong>${result.it_number || 'N/A'}</strong></td>
                        <td>${result.name || 'N/A'}</td>
                        <td><strong>${result.ca_marks || 'N/A'}</strong></td>
                        <td class="grade-${(result.status || '').toLowerCase()}"><strong>${result.grade || 'N/A'}</strong></td>
                        <td class="grade-${(result.status || '').toLowerCase()}"><strong>${result.status || 'N/A'}</strong></td>
                    </tr>
                `).join('');
            }

            // Show results section
            document.getElementById('resultsSection').style.display = 'block';
            
            // Smooth scroll to results
            setTimeout(() => {
                document.getElementById('resultsSection').scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'start' 
                });
            }, 100);
        }

        function exportToCSV() {
            if (currentResults.length === 0) {
                alert('No results to export.');
                return;
            }

            const headers = ['IT Number', 'Name', 'CA Marks', 'Grade', 'Status'];
            const rows = currentResults.map(r => [
                r.it_number,
                r.name || '',
                r.ca_marks !== null && r.ca_marks !== undefined ? r.ca_marks : 'N/A',
                r.grade,
                r.status
            ]);

            const csv = [
                headers.join(','),
                ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
            ].join('\n');

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'center_results.csv';
            a.click();
            window.URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
